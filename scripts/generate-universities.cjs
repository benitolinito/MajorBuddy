const fs = require('fs');
const path = require('path');

const csvPath = path.resolve(__dirname, '../src/data/Most-Recent-Cohorts-Institution.csv');
const outputPath = path.resolve(__dirname, '../src/data/universities.ts');

if (!fs.existsSync(csvPath)) {
  console.error(`CSV file not found at ${csvPath}.`);
  process.exit(1);
}

const csvText = fs.readFileSync(csvPath, 'utf8');
const lines = csvText.split(/\r?\n/).filter((line) => line.trim().length > 0);
if (lines.length <= 1) {
  console.error('CSV file appears to be empty.');
  process.exit(1);
}

const splitCSVLine = (line) => {
  const values = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i += 1;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }
    if (char === ',' && !inQuotes) {
      values.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current);
  return values;
};

const header = splitCSVLine(lines[0]);
const requiredColumns = ['INSTNM', 'CURROPER', 'SCH_DEG', 'PREDDEG'];
const colIndex = Object.fromEntries(requiredColumns.map((key) => [key, header.indexOf(key)]));
const missing = Object.entries(colIndex)
  .filter(([, idx]) => idx === -1)
  .map(([key]) => key);
if (missing.length) {
  console.error(`Missing required columns in CSV: ${missing.join(', ')}`);
  process.exit(1);
}

const normalizeName = (value) => value.replace(/\s+/g, ' ').trim();

const names = new Set();
for (let i = 1; i < lines.length; i++) {
  const cols = splitCSVLine(lines[i]);
  if (!cols.length) continue;
  const operating = cols[colIndex.CURROPER] === '1';
  const degreeGranting = cols[colIndex.SCH_DEG] === '1' || Number(cols[colIndex.PREDDEG]) >= 2;
  const instName = cols[colIndex.INSTNM];
  if (!operating || !degreeGranting || !instName) continue;
  const normalized = normalizeName(instName);
  if (normalized) {
    names.add(normalized);
  }
}

const sortedNames = Array.from(names).sort((a, b) => a.localeCompare(b, 'en', { sensitivity: 'base' }));
const fileHeader = `// Generated by scripts/generate-universities.js\n// Source: U.S. Department of Education College Scorecard\nexport const UNIVERSITY_SUGGESTIONS = `;
const fileContent = `${fileHeader}${JSON.stringify(sortedNames, null, 2)} as const;\n`;

fs.writeFileSync(outputPath, fileContent);
console.log(`Wrote ${sortedNames.length} universities to ${path.relative(process.cwd(), outputPath)}`);
